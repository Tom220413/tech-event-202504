<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>タスク詳細 - リモートワークス</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="redirect.js"></script>
  </head>
  <body class="bg-gray-100">
    <div id="app">
      <!-- ヘッダー -->
      <header
        :class="[
          'fixed top-0 left-0 right-0 bg-white shadow-md py-4 z-50 flex items-center px-6 transition-transform duration-300',
          isHeaderVisible ? 'translate-y-0' : '-translate-y-full'
        ]"
      >
        <h1 class="text-2xl font-bold mr-8">RemoteWorks</h1>
        <nav class="flex space-x-4">
          <a
            href="http://127.0.0.1:3000/members.html"
            class="text-gray-600 hover:text-blue-600"
            >メンバー一覧</a
          >
          <a
            href="http://127.0.0.1:3000/tasks.html"
            class="text-gray-600 hover:text-blue-600"
            >タスク一覧</a
          >
        </nav>
      </header>

      <!-- メインコンテンツ -->
      <main class="container mx-auto px-4 pt-10">
        <div v-if="!task" class="flex justify-center items-center h-64">
          <div class="text-gray-500">読み込み中...</div>
        </div>
        <div v-else class="bg-white rounded-lg p-6 max-w-2xl mx-auto">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold">タスク詳細</h2>
            <div class="flex gap-2">
              <button
                @click="deleteTask"
                class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
              >
                削除
              </button>
              <a
                href="tasks.html"
                class="px-4 py-2 border rounded hover:bg-gray-100"
              >
                戻る
              </a>
              <button
                @click="updateTask"
                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
              >
                更新
              </button>
            </div>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >タスク番号</label
              >
              <div class="mt-1 text-gray-900">{{ task.number }}</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >タイトル</label
              >
              <input
                v-model="task.title"
                type="text"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >内容</label
              >
              <textarea
                v-model="task.description"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
              ></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >担当者</label
              >
              <select
                v-model="task.assigneeId"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
              >
                <option
                  v-for="member in members"
                  :key="member.id"
                  :value="member.id"
                >
                  {{ member.name }}
                </option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >ステータス</label
              >
              <select
                v-model="task.status"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
              >
                <option
                  v-for="status in taskStatuses"
                  :key="status"
                  :value="status"
                >
                  {{ status }}
                </option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >緊急度</label
              >
              <select
                v-model="task.priority"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
              >
                <option value="高">高</option>
                <option value="中">中</option>
                <option value="低">低</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >進捗状況</label
              >
              <select
                v-model="task.progress"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
              >
                <option v-for="n in 11" :key="n" :value="(n-1)*10">
                  {{ (n-1)*10 }}%
                </option>
              </select>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script type="module">
      import {
        createApp,
        ref,
        onMounted,
      } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";
      import {
        loadMembers,
        saveMembers,
        loadTasks,
        saveTasks,
      } from "./storage.js";

      createApp({
        setup() {
          const task = ref(null);
          const members = ref([]);
          const taskStatuses = ["未着手", "進行中", "完了", "保留"];

          onMounted(() => {
            // URLからタスクIDを取得
            const urlParams = new URLSearchParams(window.location.search);
            const taskId = parseInt(urlParams.get("id"));

            // データを読み込む
            members.value = loadMembers();
            const tasks = loadTasks();

            // タスクを検索
            const foundTask = tasks.find((t) => t.id === taskId);
            if (foundTask) {
              task.value = { ...foundTask };
            } else {
              // タスクが見つからない場合はタスク一覧に戻る
              window.location.href = "tasks.html";
            }
          });

          const updateTask = () => {
            const tasks = loadTasks();
            const index = tasks.findIndex((t) => t.id === task.value.id);
            if (index !== -1) {
              tasks[index] = { ...task.value };
              saveTasks(tasks);
              window.location.href = "tasks.html";
            }
          };

          const deleteTask = () => {
            if (confirm("このタスクを削除してもよろしいですか？")) {
              const tasks = loadTasks();
              const index = tasks.findIndex((t) => t.id === task.value.id);
              if (index !== -1) {
                tasks.splice(index, 1);
                saveTasks(tasks);
                window.location.href = "tasks.html";
              }
            }
          };

          return {
            task,
            members,
            taskStatuses,
            updateTask,
            deleteTask,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
